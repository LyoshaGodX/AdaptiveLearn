# Документация приложения Methodist

## Общее описание

Приложение `methodist` является центральным модулем системы адаптивного обучения, предназначенным для управления учебными навыками, их взаимосвязями и заданиями. Приложение предоставляет функционал для методистов (преподавателей) по созданию, редактированию и организации образовательного контента.

## Архитектура приложения

### Структура файлов
```
methodist/
├── __init__.py
├── admin.py                    # Конфигурация Django Admin
├── apps.py                     # Конфигурация приложения
├── decorators.py              # Декораторы авторизации
├── models.py                  # Модели данных
├── urls.py                    # URL маршруты
├── views.py                   # Представления (контроллеры)
├── migrations/                # Миграции базы данных
├── static/methodist/          # Статические файлы (CSS, JS)
├── templates/methodist/       # HTML шаблоны
└── management/commands/       # Django команды управления
```

## Модели данных

### 1. Task (Задание)

**Назначение**: Основная модель для хранения учебных заданий различных типов.

**Поля**:
- `title` (CharField, max_length=255) - Название задания
- `task_type` (CharField, choices=TaskType.choices) - Тип задания (одиночный выбор, множественный выбор, верно/неверно)  
- `difficulty` (CharField, choices=DifficultyLevel.choices) - Уровень сложности (начальный, средний, продвинутый)
- `question_text` (TextField) - Формулировка задачи/вопроса
- `skills` (ManyToManyField) - Связанные навыки из приложения `skills`
- `courses` (ManyToManyField) - Связанные курсы из приложения `skills`
- `created_at` (DateTimeField) - Дата создания
- `updated_at` (DateTimeField) - Дата последнего обновления
- `is_active` (BooleanField) - Флаг активности задания

**Методы**:
- `__str__()` - Возвращает название задания

**Meta**:
- Сортировка по убыванию даты создания
- Verbose names для админки

### 2. TaskAnswer (Вариант ответа)

**Назначение**: Модель для хранения вариантов ответов к заданиям с выбором.

**Поля**:
- `task` (ForeignKey) - Связь с заданием
- `text` (TextField) - Текст варианта ответа
- `is_correct` (BooleanField) - Флаг правильности ответа
- `order` (IntegerField) - Порядок отображения варианта

**Связи**:
- Связь с Task через ForeignKey с CASCADE удалением
- Использует related_name='answers'

### 3. Перечисления (Choices)

**TaskType**:
- `SINGLE_CHOICE` ('single') - Один вариант ответа
- `MULTIPLE_CHOICE` ('multiple') - Множественный выбор
- `TRUE_FALSE` ('true_false') - Верно/Неверно

**DifficultyLevel**:
- `BEGINNER` ('beginner') - Начальный
- `INTERMEDIATE` ('intermediate') - Средний  
- `ADVANCED` ('advanced') - Продвинутый

## Представления (Views)

### 1. Управление навыками

#### `skill_graph(request)`
**URL**: `/methodist/`
**Назначение**: Отображение интерактивной карты навыков с возможностью фильтрации

**Функционал**:
- Визуализация графа навыков с помощью Cytoscape.js
- Фильтрация по курсам
- Выбор конкретного навыка для фокуса
- Отображение зависимостей между навыками

**Параметры GET**:
- `course` - ID курса для фильтрации
- `skill` - ID навыка для выделения

#### `edit_skills(request)`
**URL**: `/methodist/edit/`
**Декораторы**: `@login_required`, `@methodist_required`
**Назначение**: Страница редактирования навыков и их связей

**Функционал**:
- Поиск навыков по названию
- Фильтрация по курсам
- Выбор навыка для редактирования
- Интерактивный граф связей навыков
- Управление предпосылками навыков

#### `edit_skill(request)`
**URL**: `/methodist/edit_skill/`
**Метод**: POST
**Назначение**: Создание и редактирование навыков

**Параметры POST**:
- `skill_id` - ID навыка (для редактирования)
- `name` - Название навыка
- `is_base` - Флаг базового навыка
- `courses` - Список ID курсов

#### `delete_skill(request)`
**URL**: `/methodist/delete_skill/`
**Метод**: POST
**Назначение**: Удаление навыка

#### `update_skill_courses(request)`
**URL**: `/methodist/update_skill_courses/`
**Метод**: POST
**Назначение**: Обновление связей навыка с курсами

### 2. API для управления зависимостями навыков

#### `api_add_prerequisite(request)`
**URL**: `/methodist/api/add_prerequisite/`
**Метод**: POST
**Назначение**: Добавление предварительного требования к навыку

**Функционал**:
- Проверка на циклические зависимости
- Валидация существования навыков
- Предотвращение дублирования связей

#### `api_remove_prerequisite(request)`
**URL**: `/methodist/api/remove_prerequisite/`
**Метод**: POST
**Назначение**: Удаление предварительного требования

#### `api_skill_details(request, skill_id)`
**URL**: `/methodist/api/skills/<int:skill_id>/details/`
**Метод**: GET
**Назначение**: Получение подробной информации о навыке

**Возвращает JSON**:
- Основные данные навыка
- Количество предпосылок
- Количество зависимых навыков
- Список связанных курсов

#### `api_remove_dependent(request)`
**URL**: `/methodist/api/remove_dependent/`
**Метод**: POST
**Назначение**: Удаление зависимого навыка

### 3. Управление заданиями

#### `tasks_list(request)`
**URL**: `/methodist/tasks/`
**Назначение**: Список всех заданий с возможностями фильтрации

**Фильтры**:
- Поиск по названию и тексту
- Фильтрация по курсам
- Фильтрация по уровню сложности
- Фильтрация по навыкам

#### `task_create(request)`
**URL**: `/methodist/tasks/create/`
**Назначение**: Создание нового задания

**Функционал**:
- Форма создания задания
- Поддержка всех типов заданий
- Настройка вариантов ответов
- Связывание с навыками и курсами

#### `task_edit(request, task_id)`
**URL**: `/methodist/tasks/<int:task_id>/edit/`
**Назначение**: Редактирование существующего задания

#### `task_delete(request, task_id)`
**URL**: `/methodist/tasks/<int:task_id>/delete/`
**Метод**: POST
**Назначение**: Удаление задания

### 4. Вспомогательные функции

#### `generate_cytoscape_data(skills_queryset, selected_skill_id)`
**Назначение**: Генерация данных для интерактивного графа навыков

**Параметры**:
- `skills_queryset` - Набор навыков для отображения
- `selected_skill_id` - ID выбранного навыка

**Возвращает**: JSON с узлами и ребрами для Cytoscape.js

#### `_handle_task_form(request, task)`
**Назначение**: Обработка формы создания/редактирования задания

**Функционал**:
- Валидация данных формы
- Создание/обновление задания
- Обработка вариантов ответов для разных типов заданий
- Установка связей с навыками и курсами

## Декораторы авторизации

### `@methodist_required`
**Файл**: `decorators.py`
**Назначение**: Проверка прав доступа методиста

**Логика проверки**:
1. Проверка аутентификации пользователя
2. Проверка, что в username содержится 'methodist' ИЛИ пользователь является суперпользователем
3. Возврат 403 Forbidden при отсутствии прав

## URL маршруты

### Основные страницы
- `/methodist/` - Карта навыков
- `/methodist/edit/` - Редактирование навыков
- `/methodist/tasks/` - Список заданий
- `/methodist/tasks/create/` - Создание задания
- `/methodist/tasks/<id>/edit/` - Редактирование задания

### API эндпоинты
- `/methodist/api/skills/<id>/details/` - Детали навыка
- `/methodist/api/add_prerequisite/` - Добавление предпосылки
- `/methodist/api/remove_prerequisite/` - Удаление предпосылки
- `/methodist/api/remove_dependent/` - Удаление зависимости

### Действия с данными
- `/methodist/edit_skill/` - Создание/редактирование навыка
- `/methodist/delete_skill/` - Удаление навыка
- `/methodist/tasks/<id>/delete/` - Удаление задания

## Шаблоны (Templates)

### 1. `base.html`
**Назначение**: Базовый шаблон для всех страниц приложения
**Содержит**: Общую структуру, навигацию, подключение стилей

### 2. `skills_list.html`
**Назначение**: Отображение карты навыков
**Особенности**:
- Интерактивный граф на Cytoscape.js
- Фильтры по курсам и навыкам
- Современный адаптивный дизайн
- Анимации и эффекты

### 3. `skills_edit.html`
**Назначение**: Страница редактирования навыков
**Функционал**:
- Форма создания/редактирования навыков
- Управление предпосылками через drag&drop
- Визуализация связей
- AJAX операции

### 4. `tasks_list.html`
**Назначение**: Список заданий с фильтрацией
**Элементы**:
- Карточки заданий
- Фильтры и поиск
- Статистика по заданиям
- Действия редактирования/удаления

### 5. `task_form.html`
**Назначение**: Форма создания/редактирования заданий
**Особенности**:
- Динамическое отображение полей в зависимости от типа задания
- Редактор Markdown для текста вопросов
- Управление вариантами ответов
- Валидация на клиентской стороне

## Статические файлы

### CSS файлы
- `styles.css` - Основные стили приложения
- `css/tasks.css` - Стили для страниц заданий
- `css/task-form.css` - Стили формы заданий

### JavaScript файлы
- `skills_graph.js` - Логика интерактивного графа навыков
- `skills_edit.js` - Функционал редактирования навыков
- `skills_course_selector.js` - Селектор курсов

## Административная панель

### TaskAdmin
**Модель**: Task
**Отображение**: title, task_type, difficulty, is_active, created_at
**Фильтры**: По типу, сложности, активности, курсам, навыкам
**Поиск**: По названию и тексту вопроса
**Горизонтальные фильтры**: Для курсов и навыков

### TaskAnswerAdmin  
**Модель**: TaskAnswer
**Отображение**: task, text, is_correct, order
**Фильтры**: По правильности ответа и типу задания
**Поиск**: По тексту ответа и названию задания

## Особенности реализации

### 1. Интерактивная визуализация навыков
- Использование библиотеки Cytoscape.js для создания интерактивных графов
- Динамическая генерация данных графа с учетом фильтров
- Поддержка выделения выбранного навыка и его связей

### 2. Проверка циклических зависимостей
- Алгоритм обхода графа для предотвращения создания циклов в зависимостях навыков
- Валидация на уровне API при добавлении предпосылок

### 3. Гибкая система заданий
- Поддержка различных типов заданий (выбор, множественный выбор, верно/неверно)
- Динамическое управление вариантами ответов
- Связывание заданий с навыками и курсами

### 4. Современный UI/UX
- Адаптивный дизайн для всех устройств
- Анимации и переходы CSS
- Интуитивно понятные интерфейсы
- Contextual подсказки и валидация

### 5. Безопасность
- Декораторы авторизации для всех критичных операций
- CSRF защита для всех POST запросов
- Валидация входных данных на сервере

## Зависимости

### Python пакеты
- Django (фреймворк)
- Подключение к приложению `skills` для работы с моделями Skill и Course

### JavaScript библиотеки
- Cytoscape.js - для интерактивных графов
- Vis.js - для дополнительной визуализации
- Bootstrap - для UI компонентов
- Font Awesome - для иконок

### CSS фреймворки
- Bootstrap 5 - основной CSS фреймворк
- Кастомные стили для специфичного дизайна

## Будущие улучшения

### Планируемые функции
1. Импорт/экспорт заданий в различных форматах
2. Система тегов для заданий
3. Аналитика по выполнению заданий
4. Версионирование заданий
5. Коллаборативное редактирование
6. Интеграция с внешними системами оценивания

### Технические улучшения
1. Кэширование графов навыков
2. Оптимизация запросов к БД
3. Добавление тестов
4. Документирование API
5. Логирование действий пользователей

## Контактная информация

Для вопросов по разработке и сопровождению приложения обращайтесь к команде разработки системы адаптивного обучения.

---
*Документация актуальна на 12 июня 2025 года*
