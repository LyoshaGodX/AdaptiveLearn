{% extends 'methodist/base.html' %}
{% load static %}

{% block title %}
{% if is_editing %}Редактировать задание{% else %}Создать задание{% endif %} - Методист
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'methodist/css/task-form.css' %}">
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <!-- Заголовок -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="h3 mb-0">
                    <i class="fas fa-{% if is_editing %}edit{% else %}plus{% endif %} me-2 text-primary"></i>
                    {% if is_editing %}Редактировать задание{% else %}Создать задание{% endif %}
                </h1>
                <a href="{% url 'methodist_tasks' %}" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left me-2"></i>Назад к списку
                </a>
            </div>

            <!-- Форма -->
            <form method="post" enctype="multipart/form-data" class="task-form">
                {% csrf_token %}
                
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">Основная информация</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="title" class="form-label">Название задания <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="title" name="title" 
                                           value="{% if task %}{{ task.title }}{% endif %}" required>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label for="task_type" class="form-label">Тип задания <span class="text-danger">*</span></label>
                                    <select class="form-select" id="task_type" name="task_type" required>
                                        {% for value, label in task_types %}
                                        <option value="{{ value }}" 
                                                {% if task and task.task_type == value %}selected{% endif %}>
                                            {{ label }}
                                        </option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label for="difficulty" class="form-label">Сложность <span class="text-danger">*</span></label>
                                    <select class="form-select" id="difficulty" name="difficulty" required>
                                        {% for value, label in difficulty_choices %}
                                        <option value="{{ value }}" 
                                                {% if task and task.difficulty == value %}selected{% endif %}>
                                            {{ label }}
                                        </option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">Формулировка задачи</h5>
                    </div>
                    <div class="card-body">                        <div class="mb-3">
                            <label for="question_text" class="form-label">Текст вопроса/условие <span class="text-danger">*</span></label>
                            
                            <!-- Панель инструментов Markdown -->
                            <div class="markdown-toolbar mb-2">
                                <div class="btn-group" role="group">
                                    <button type="button" class="btn btn-sm btn-outline-secondary markdown-btn" data-action="bold" title="Жирный">
                                        <i class="fas fa-bold"></i>
                                    </button>
                                    <button type="button" class="btn btn-sm btn-outline-secondary markdown-btn" data-action="italic" title="Курсив">
                                        <i class="fas fa-italic"></i>
                                    </button>
                                    <button type="button" class="btn btn-sm btn-outline-secondary markdown-btn" data-action="underline" title="Подчеркнутый">
                                        <i class="fas fa-underline"></i>
                                    </button>
                                    <button type="button" class="btn btn-sm btn-outline-secondary markdown-btn" data-action="strikethrough" title="Зачеркнутый">
                                        <i class="fas fa-strikethrough"></i>
                                    </button>
                                </div>
                                
                                <div class="btn-group ms-2" role="group">
                                    <button type="button" class="btn btn-sm btn-outline-secondary markdown-btn" data-action="h1" title="Заголовок 1">
                                        H1
                                    </button>
                                    <button type="button" class="btn btn-sm btn-outline-secondary markdown-btn" data-action="h2" title="Заголовок 2">
                                        H2
                                    </button>
                                    <button type="button" class="btn btn-sm btn-outline-secondary markdown-btn" data-action="h3" title="Заголовок 3">
                                        H3
                                    </button>
                                </div>
                                
                                <div class="btn-group ms-2" role="group">
                                    <button type="button" class="btn btn-sm btn-outline-secondary markdown-btn" data-action="ul" title="Маркированный список">
                                        <i class="fas fa-list-ul"></i>
                                    </button>
                                    <button type="button" class="btn btn-sm btn-outline-secondary markdown-btn" data-action="ol" title="Нумерованный список">
                                        <i class="fas fa-list-ol"></i>
                                    </button>
                                    <button type="button" class="btn btn-sm btn-outline-secondary markdown-btn" data-action="blockquote" title="Цитата">
                                        <i class="fas fa-quote-right"></i>
                                    </button>
                                    <button type="button" class="btn btn-sm btn-outline-secondary markdown-btn" data-action="code" title="Код">
                                        <i class="fas fa-code"></i>
                                    </button>
                                </div>
                                  <div class="btn-group ms-2" role="group">
                                    <button type="button" class="btn btn-sm btn-outline-secondary markdown-btn" data-action="link" title="Ссылка">
                                        <i class="fas fa-link"></i>
                                    </button>
                                    <button type="button" class="btn btn-sm btn-outline-secondary markdown-btn" data-action="image" title="Изображение">
                                        <i class="fas fa-image"></i>
                                    </button>
                                    <button type="button" class="btn btn-sm btn-outline-secondary markdown-btn" data-action="video" title="Видео">
                                        <i class="fas fa-video"></i>
                                    </button>
                                    <button type="button" class="btn btn-sm btn-outline-secondary markdown-btn" data-action="table" title="Таблица">
                                        <i class="fas fa-table"></i>
                                    </button>
                                </div>
                                
                                <div class="ms-auto">
                                    <button type="button" class="btn btn-sm btn-outline-primary" id="toggle-markdown-view" title="Переключить режим просмотра">
                                        <i class="fas fa-eye"></i> Предпросмотр
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Контейнер редактора -->
                            <div class="markdown-editor-container">
                                <textarea class="form-control markdown-textarea" id="question_text" name="question_text" 
                                          rows="6" required>{% if task %}{{ task.question_text }}{% endif %}</textarea>
                                <div class="markdown-preview" id="question_text_preview" style="display: none;"></div>
                            </div>                        </div>
                    </div>
                </div>

                <!-- Варианты ответов (показываются только для заданий с выбором) -->
                <div class="card mb-4" id="answers-section" style="display: none;">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Варианты ответов</h5>
                        <button type="button" class="btn btn-sm btn-outline-primary" id="add-answer">
                            <i class="fas fa-plus me-1"></i>Добавить вариант
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="answers-container">
                            <!-- Варианты ответов будут добавлены здесь через JavaScript -->
                        </div>
                        <div id="true-false-container" class="row" style="display: none;">
                            <!-- Для типа "верно/неверно" - фиксированные варианты -->
                            <div class="col-md-6">
                                <div class="answer-item p-3 border rounded mb-3">
                                    <div class="d-flex align-items-center">
                                        <div class="flex-grow-1">
                                            <strong>Верно</strong>
                                        </div>
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="radio" name="true_false_answer" 
                                                   value="true" id="answer-true">
                                            <label class="form-check-label" for="answer-true">
                                                Правильный
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="answer-item p-3 border rounded mb-3">
                                    <div class="d-flex align-items-center">
                                        <div class="flex-grow-1">
                                            <strong>Неверно</strong>
                                        </div>
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="radio" name="true_false_answer" 
                                                   value="false" id="answer-false">
                                            <label class="form-check-label" for="answer-false">
                                                Правильный
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Правильный ответ (для открытых вопросов) -->
                <div class="card mb-4" id="correct-answer-section">
                    <div class="card-header">
                        <h5 class="mb-0">Правильный ответ</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="correct_answer" class="form-label">Правильный ответ <span class="text-danger">*</span></label>
                            <textarea class="form-control" id="correct_answer" name="correct_answer" 
                                      rows="3" required>{% if task %}{{ task.correct_answer }}{% endif %}</textarea>
                        </div>
                        <div class="mb-3">
                            <label for="explanation" class="form-label">Объяснение ответа</label>
                            <textarea class="form-control" id="explanation" name="explanation" 
                                      rows="3">{% if task %}{{ task.explanation|default_if_none:'' }}{% endif %}</textarea>
                        </div>
                    </div>
                </div>                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">Связи с навыками и курсами</h5>
                    </div>
                    <div class="card-body">
                        <!-- Навыки с фильтрами -->                        <div class="mb-4">
                            <label class="form-label">Связанные навыки <span class="text-danger">*</span></label>
                            
                              <!-- Фильтры для навыков -->
                            <div class="mb-3">
                                <div class="row g-2">
                                    <div class="col-md-6">
                                        <input type="text" class="form-control" id="skill-search" 
                                               placeholder="Поиск по названию навыка...">
                                    </div>
                                    <div class="col-md-3">
                                        <select class="form-select" id="skill-course-filter">
                                            <option value="">Все курсы</option>
                                            {% for course in courses %}
                                            <option value="{{ course.name|lower }}">{{ course.name }}</option>
                                            {% endfor %}
                                            <option value="без курса">Без курса</option>
                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <button type="button" class="btn btn-outline-secondary w-100" id="clear-skill-filters">
                                            <i class="fas fa-times me-1"></i>Очистить
                                        </button>
                                    </div>
                                </div>
                            </div>                              <!-- Список навыков в виде плитки -->
                            <div class="skills-container" style="max-height: 400px; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 0.375rem; padding: 1rem;">
                                <div id="skills-list" class="row g-2">
                                    <!-- Простое отображение всех навыков для отладки -->
                                    {% for skill in skills %}
                                    <div class="col-md-6 col-lg-4">
                                        <div class="skill-card p-2 border rounded" 
                                             data-name="{{ skill.name|lower }}" 
                                             data-course="{{ skill.courses.first.name|default:'без курса'|lower }}">
                                            <div class="form-check h-100">
                                                <input class="form-check-input" type="checkbox" name="skills" 
                                                       value="{{ skill.id }}" id="skill-{{ skill.id }}"
                                                       {% if task and skill in task.skills.all %}checked{% endif %}>
                                                <label class="form-check-label w-100" for="skill-{{ skill.id }}">
                                                    <div class="skill-card-content">
                                                        <div class="skill-title fw-bold">{{ skill.name }}</div>
                                                        <div class="skill-meta d-flex justify-content-between align-items-center mt-1">
                                                            {% if skill.courses.first %}
                                                            <small class="text-primary">
                                                                <i class="fas fa-book me-1" style="font-size: 0.7em;"></i>{{ skill.courses.first.name }}
                                                            </small>
                                                            {% else %}
                                                            <small class="text-muted">
                                                                <i class="fas fa-question-circle me-1" style="font-size: 0.7em;"></i>Без курса
                                                            </small>
                                                            {% endif %}
                                                        </div>
                                                        {% if skill.description %}
                                                        <small class="text-muted d-block mt-1" style="font-size: 0.75em; line-height: 1.2;">
                                                            {{ skill.description|truncatechars:60 }}
                                                        </small>
                                                        {% endif %}
                                                    </div>
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                    {% empty %}
                                    <div class="col-12">
                                        <div class="alert alert-warning">
                                            <i class="fas fa-exclamation-triangle me-2"></i>
                                            Навыки не найдены. Проверьте подключение к базе данных.
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                                <div id="no-skills-found" class="text-center text-muted py-3" style="display: none;">
                                    <i class="fas fa-search me-2"></i>Навыки не найдены
                                </div>
                            </div>
                            <small class="form-text text-muted">Выберите навыки, которые развивает данное задание</small>
                        </div>
                          <!-- Курсы с тогглетами -->
                        <div class="mb-3">
                            <label class="form-label">Связанный курс</label>
                            <div class="courses-container">
                                <div class="row">
                                    {% for course in courses %}
                                    <div class="col-md-6 mb-3">
                                        <div class="course-item p-3 border rounded {% if task and course in task.courses.all %}border-primary bg-light{% endif %}">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <div class="flex-grow-1">
                                                    <strong>{{ course.name }}</strong>
                                                    {% if course.description %}
                                                    <div class="text-muted small mt-1">{{ course.description|truncatechars:80 }}</div>
                                                    {% endif %}
                                                </div>
                                                <div class="form-check form-switch">
                                                    <input class="form-check-input course-toggle" type="radio" 
                                                           name="course" value="{{ course.id }}" id="course-{{ course.id }}"
                                                           {% if task and course in task.courses.all %}checked{% endif %}>
                                                    <label class="form-check-label" for="course-{{ course.id }}">
                                                        Выбрать
                                                    </label>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                            <small class="form-text text-muted">Выберите курс для данного задания</small>
                        </div>
                    </div>
                </div>                <!-- Кнопки действий -->
                <div class="d-flex justify-content-between">
                    <a href="{% url 'methodist_tasks' %}" class="btn btn-secondary">
                        <i class="fas fa-times me-2"></i>Отмена
                    </a>
                    <div>
                        <button type="button" class="btn btn-info me-2" id="preview-task-btn">
                            <i class="fas fa-eye me-2"></i>Предпросмотр
                        </button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save me-2"></i>
                            {% if is_editing %}Сохранить изменения{% else %}Создать задание{% endif %}
                        </button>
                    </div>
                </div>
            </form>        </div>
    </div>
</div>

<!-- Модальное окно предпросмотра задания -->
<div class="modal fade" id="preview-modal" tabindex="-1" aria-labelledby="previewModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="previewModalLabel">
                    <i class="fas fa-eye me-2"></i>Предпросмотр задания
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Закрыть"></button>
            </div>
            <div class="modal-body">
                <!-- Здесь будет отображаться предпросмотр задания -->
                <div id="preview-content">
                    <!-- Контент генерируется JavaScript -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>Закрыть
                </button>
                <button type="button" class="btn btn-primary" id="save-from-preview">
                    <i class="fas fa-save me-2"></i>
                    {% if is_editing %}Сохранить изменения{% else %}Создать задание{% endif %}
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Шаблон для варианта ответа -->
<template id="answer-template">
    <div class="answer-item mb-3 p-3 border rounded">
        <div class="d-flex align-items-start">
            <div class="flex-grow-1 me-3">
                <!-- Мини-панель инструментов Markdown для ответов -->                <div class="markdown-toolbar mb-1">
                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-sm btn-outline-secondary markdown-btn" data-action="bold" title="Жирный">
                            <i class="fas fa-bold"></i>
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-secondary markdown-btn" data-action="italic" title="Курсив">
                            <i class="fas fa-italic"></i>
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-secondary markdown-btn" data-action="code" title="Код">
                            <i class="fas fa-code"></i>
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-secondary markdown-btn" data-action="link" title="Ссылка">
                            <i class="fas fa-link"></i>
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-secondary markdown-btn" data-action="image" title="Изображение">
                            <i class="fas fa-image"></i>
                        </button>
                    </div>
                    <div class="ms-auto">
                        <button type="button" class="btn btn-sm btn-outline-primary toggle-answer-markdown" title="Переключить режим">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                </div>
                
                <!-- Контейнер редактора ответа -->
                <div class="markdown-editor-container">
                    <input type="text" class="form-control markdown-textarea" name="answer_text" placeholder="Текст ответа" required>
                    <div class="markdown-preview" style="display: none;"></div>
                </div>
            </div>
            <div class="me-3">
                <div class="form-check form-switch">
                    <input class="form-check-input answer-correct" type="checkbox" name="correct_answers" value="">
                    <label class="form-check-label">
                        Правильный
                    </label>
                </div>
            </div>
            <div>
                <button type="button" class="btn btn-sm btn-outline-danger remove-answer">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        </div>
    </div>
</template>

<!-- Модальные окна для Markdown редактора -->

<!-- Модальное окно для вставки ссылки -->
<div class="modal fade" id="link-modal" tabindex="-1" aria-labelledby="linkModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="linkModalLabel">
                    <i class="fas fa-link me-2"></i>Вставить ссылку
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Закрыть"></button>
            </div>
            <div class="modal-body">
                <form id="link-form">
                    <div class="mb-3">
                        <label for="link-url" class="form-label">URL ссылки <span class="text-danger">*</span></label>
                        <input type="url" class="form-control" id="link-url" placeholder="https://example.com" required>
                        <div class="form-text">Введите полный URL, включая http:// или https://</div>
                    </div>
                    <div class="mb-3">
                        <label for="link-text" class="form-label">Текст ссылки</label>
                        <input type="text" class="form-control" id="link-text" placeholder="Описание ссылки">
                        <div class="form-text">Если не указано, будет использован выделенный текст или URL</div>
                    </div>
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="link-new-window" checked>
                            <label class="form-check-label" for="link-new-window">
                                Открывать в новом окне
                            </label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                <button type="button" class="btn btn-primary" id="insert-link-btn">
                    <i class="fas fa-plus me-2"></i>Вставить ссылку
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно для вставки изображения -->
<div class="modal fade" id="image-modal" tabindex="-1" aria-labelledby="imageModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="imageModalLabel">
                    <i class="fas fa-image me-2"></i>Вставить изображение
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Закрыть"></button>
            </div>
            <div class="modal-body">
                <form id="image-form">
                    <div class="mb-3">
                        <label for="image-url" class="form-label">URL изображения <span class="text-danger">*</span></label>
                        <input type="url" class="form-control" id="image-url" placeholder="https://example.com/image.jpg" required>
                        <div class="form-text">Введите прямую ссылку на изображение (jpg, png, gif, webp)</div>
                    </div>
                    <div class="mb-3">
                        <label for="image-alt" class="form-label">Альтернативный текст</label>
                        <input type="text" class="form-control" id="image-alt" placeholder="Описание изображения">
                        <div class="form-text">Краткое описание изображения для доступности</div>
                    </div>
                    <div class="mb-3">
                        <label for="image-title" class="form-label">Заголовок изображения</label>
                        <input type="text" class="form-control" id="image-title" placeholder="Заголовок (показывается при наведении)">
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <label for="image-width" class="form-label">Ширина (px)</label>
                            <input type="number" class="form-control" id="image-width" min="50" max="1000" placeholder="300">
                        </div>
                        <div class="col-md-6">
                            <label for="image-height" class="form-label">Высота (px)</label>
                            <input type="number" class="form-control" id="image-height" min="50" max="1000" placeholder="200">
                        </div>
                    </div>
                    <div class="form-text">Размеры необязательны. Если не указаны, изображение будет отображаться в исходном размере</div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                <button type="button" class="btn btn-primary" id="insert-image-btn">
                    <i class="fas fa-plus me-2"></i>Вставить изображение
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно для вставки видео -->
<div class="modal fade" id="video-modal" tabindex="-1" aria-labelledby="videoModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="videoModalLabel">
                    <i class="fas fa-video me-2"></i>Вставить видео
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Закрыть"></button>
            </div>
            <div class="modal-body">
                <form id="video-form">
                    <div class="mb-3">
                        <label for="video-url" class="form-label">URL видео <span class="text-danger">*</span></label>
                        <input type="url" class="form-control" id="video-url" placeholder="https://youtube.com/watch?v=..." required>
                        <div class="form-text">
                            Поддерживаются ссылки на:<br>
                            • YouTube (youtube.com, youtu.be)<br>
                            • Vimeo (vimeo.com)<br>
                            • Прямые ссылки на видеофайлы (.mp4, .webm, .ogg)
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="video-title" class="form-label">Заголовок видео</label>
                        <input type="text" class="form-control" id="video-title" placeholder="Название видео">
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <label for="video-width" class="form-label">Ширина (px)</label>
                            <input type="number" class="form-control" id="video-width" min="200" max="1000" placeholder="560">
                        </div>
                        <div class="col-md-6">
                            <label for="video-height" class="form-label">Высота (px)</label>
                            <input type="number" class="form-control" id="video-height" min="150" max="800" placeholder="315">
                        </div>
                    </div>
                    <div class="form-text mt-2">Размеры по умолчанию: 560x315 (стандарт YouTube)</div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                <button type="button" class="btn btn-primary" id="insert-video-btn">
                    <i class="fas fa-plus me-2"></i>Вставить видео
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script src="{% static 'methodist/js/task-form.js' %}"></script>
{% if task and task.answers.exists %}
<script type="application/json" id="existing-answers-data">
[
    {% for answer in task.answers.all %}
    {
        "text": "{{ answer.text|escapejs }}",
        "is_correct": {{ answer.is_correct|yesno:"true,false" }}
    }{% if not forloop.last %},{% endif %}
    {% endfor %}
]
</script>
<script>
    // Загружаем существующие варианты ответов
    document.addEventListener('DOMContentLoaded', function() {
        const dataElement = document.getElementById('existing-answers-data');
        if (dataElement) {
            window.existingAnswers = JSON.parse(dataElement.textContent);
        }
    });
</script>
{% endif %}
{% endblock %}
