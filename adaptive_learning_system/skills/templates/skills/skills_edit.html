{% load static %}
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Редактирование навыков - Адаптивное обучение</title>
    
    <!-- Tailwind CSS (CDN) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- Vis.js библиотеки -->
    <script src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
    <script src="https://unpkg.com/vis-data/standalone/umd/vis-data.min.js"></script>
    <!-- Единый файл стилей -->
    <link rel="stylesheet" href="{% static 'skills/styles.css' %}">
    <!-- Удалены все кастомные CSS-классы для карточек, кнопок и бейджей -->
    <style>
      /* Оставляем только минимальные правки, если нужно, например, для модальных анимаций */
    </style>
</head>
<body class="bg-gray-100 pt-6">
    <div class="container mx-auto px-4 max-w-7xl">
        <header class="mb-6">
            <h1 class="text-3xl font-bold text-gray-800 mb-4">Система адаптивного обучения</h1>
            <nav class="bg-white shadow-sm rounded-lg p-3 mb-6">
                <div class="container mx-auto flex items-center justify-between">
                    <a href="/" class="text-xl font-semibold text-gray-800">Адаптивное обучение</a>
                    <ul class="flex space-x-4">
                        <li><a href="/" class="font-medium">Навыки</a></li>
                        <li><a href="/edit/" class="text-blue-600 font-medium">Редактирование навыков</a></li>
                    </ul>
                </div>
            </nav>
        </header>

        <main>
            <!-- Фильтры и поиск навыков -->
            <div class="mb-6">
                <div class="bg-white rounded-lg shadow-md overflow-hidden border border-gray-200 mb-6">
    <div class="px-4 py-3 bg-gray-50 border-b border-gray-200 font-semibold">
        <h4 class="text-lg font-semibold">Выбор навыка для редактирования</h4>
    </div>
    <div class="p-4">
        <form method="get" class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div class="mb-4">
                <label for="course" class="block text-gray-700 text-sm font-medium mb-1">Курс:</label>
                <select name="course" id="course" class="border border-gray-300 rounded px-3 py-2 pr-8 focus:outline-none focus:ring-2 focus:ring-blue-600 focus:border-transparent w-full" onchange="this.form.submit()">
                    <option value="">Все курсы</option>
                    {% for course in courses %}
                        <option value="{{ course.id }}" {% if course.id == selected_course_id %}selected{% endif %}>{{ course.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="mb-4">
                <label for="search" class="block text-gray-700 text-sm font-medium mb-1">Поиск по названию:</label>
                <input type="text" name="search" id="search" class="border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-600 focus:border-transparent w-full" value="{{ search_query }}" placeholder="Введите название навыка">
            </div>
            <div class="mb-4 flex items-end">
                <button type="submit" class="px-3 py-1 rounded-md font-medium transition-colors duration-200 bg-blue-600 text-white hover:bg-blue-700">
                    <i class="fas fa-search mr-1"></i> Найти
                </button>
                <a href="/edit/" class="ml-2 px-3 py-1 rounded-md font-medium transition-colors duration-200 border border-blue-600 text-blue-600 hover:bg-blue-600 hover:text-white">
                    <i class="fas fa-times mr-1"></i> Сбросить фильтры
                </a>
            </div>
        </form>
    </div>
</div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- Левая колонка: список навыков -->
                <div class="lg:col-span-1 order-2 lg:order-1">
                    <div class="card mb-6 bg-white rounded-lg shadow-md overflow-hidden border border-gray-200">
                            <div class="card-header px-4 py-3 bg-gray-50 border-b border-gray-200 font-semibold">
                                <h5 class="text-lg font-semibold">Список навыков</h5>
                            </div>
                            <div class="card-body p-0">
                                <ul class="divide-y divide-gray-200 max-h-96 overflow-y-auto">
                                    {% for skill in filtered_skills %}
                                    <li class="{% if skill.id == selected_skill.id %}bg-blue-50{% endif %}">
                                        <a href="?skill={{ skill.id }}&course={{ selected_course_id }}&search={{ search_query }}" 
                                           class="block px-4 py-3 hover:bg-gray-50 transition-colors">
                                            <div class="font-medium {% if skill.is_base %}text-blue-600{% endif %}">
                                                {{ skill.name }}
                                            </div>
                                            <div class="text-xs text-gray-500">
                                                ID: {{ skill.id }} | 
                                                {% if skill.is_base %}Базовый{% else %}Прикладной{% endif %} | 
                                                Зависимостей: {{ skill.prerequisites.count }}
                                            </div>
                                        </a>
                                    </li>
                                    {% empty %}
                                    <li class="px-4 py-3 text-gray-500">Навыки не найдены</li>
                                    {% endfor %}
                                </ul>
                            </div>
                            <div class="card-footer px-4 py-3 bg-gray-50 border-t border-gray-200">
                                <button id="create-skill-btn" class="w-full flex items-center justify-center gap-2 px-3 py-2 rounded-md font-medium transition-colors duration-200 bg-green-600 text-white hover:bg-green-700">
                                    <i class="fas fa-plus"></i> Создать новый навык
                                </button>
                            </div>
                        </div>
                </div>

                <!-- Правая колонка: граф и редактирование выбранного навыка -->
                <div class="lg:col-span-2 order-1 lg:order-2">
                    {% if selected_skill %}
                    <!-- Информация о выбранном навыке с добавлением лейблов курсов -->
                    <div class="card mb-6 bg-white rounded-lg shadow-md overflow-hidden border border-gray-200">
                        <div class="card-header px-4 py-3 bg-gray-50 border-b border-gray-200 font-semibold">
                            <div class="flex flex-col md:flex-row md:items-center justify-between">
                                <div>
                                    <h5 class="text-lg font-semibold mb-2 md:mb-0 flex items-center gap-2">
                                        {{ selected_skill.name }}
                                        {% if selected_skill.is_base %}
                                        <span class="inline-block px-2 py-1 rounded-full text-xs font-semibold text-white bg-blue-600">Базовый</span>
                                        {% else %}
                                        <span class="inline-block px-2 py-1 rounded-full text-xs font-semibold text-white bg-green-600">Прикладной</span>
                                        {% endif %}
                                    </h5>
                                    <div class="flex flex-wrap gap-1 mt-2">
                                        {% for course in selected_skill.courses.all %}
                                        <span class="inline-block px-2 py-1 rounded-full text-xs font-semibold text-white bg-gray-500">{{ course.name }}</span>
                                        {% empty %}
                                        <span class="text-xs text-gray-500 italic">Не привязан к курсам</span>
                                        {% endfor %}
                                    </div>
                                </div>
                                <div class="flex flex-wrap gap-2 mt-2 md:mt-0">
                                    <button id="rename-skill-btn" class="flex items-center gap-1 px-3 py-1 rounded-md font-medium transition-colors duration-200 border border-blue-600 text-blue-600 hover:bg-blue-600 hover:text-white text-sm" data-skill-id="{{ selected_skill.id }}" data-skill-name="{{ selected_skill.name }}" data-is-base="{{ selected_skill.is_base|yesno:"true,false" }}">
                                        <i class="fas fa-edit"></i> Редактировать навык
                                    </button>
                                    <button id="delete-skill-btn" class="flex items-center gap-1 px-3 py-1 rounded-md font-medium transition-colors duration-200 bg-red-600 text-white hover:bg-red-700 text-sm" data-skill-id="{{ selected_skill.id }}" data-skill-name="{{ selected_skill.name }}">
                                        <i class="fas fa-trash"></i> Удалить
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Граф для выбранного навыка -->
                    <div class="card mb-6 bg-white rounded-lg shadow-md overflow-hidden border border-gray-200">
                        <div class="bg-blue-600 text-white px-4 py-3">
                            <h4 class="text-xl font-bold m-0">Граф связей навыка</h4>
                        </div>
                        <div class="p-0 relative">
                            <div id="network-container" class="w-full h-[350px] border-b border-gray-200"></div>
                            <div id="loading-indicator" class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-white bg-opacity-90 px-6 py-4 rounded-lg shadow-lg text-center z-50" style="display: none;">
                                <i class="fas fa-circle-notch fa-spin text-blue-600 text-3xl mb-3"></i>
                                <p id="loading-text" class="text-gray-700 font-medium">Расположение узлов оптимизируется...</p>
                            </div>
                        </div>
                    </div>

                    <!-- Два столбца зависимостей -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <div class="bg-white rounded-lg shadow-md overflow-hidden border border-gray-200">
                            <div class="px-4 py-3 bg-blue-50 border-b border-blue-200 font-semibold">
                                <h6 class="text-md font-semibold text-blue-700">
                                    {% if selected_skill %}{{ selected_skill.name }}{% else %}Навык{% endif %} зависит от
                                </h6>
                            </div>
                            <div class="p-4">
                                <ul class="space-y-2">
                                    {% for prereq_skill in selected_skill.prerequisites.all %}
                                    <li class="flex items-center bg-blue-100 rounded px-3 py-2 justify-between">
                                        <div>
                                            <span class="font-medium text-blue-900">{{ prereq_skill.name }}</span>
                                            <span class="text-xs text-blue-500 ml-2">ID: {{ prereq_skill.id }}</span>
                                        </div>
                                        <button type="button"
                                            class="remove-prerequisite-btn flex items-center gap-1 px-2 py-1 rounded-md font-medium transition-colors duration-200 bg-red-100 text-red-700 hover:bg-red-200 text-xs"
                                            title="Удалить связь"
                                            data-skill-id="{{ selected_skill.id }}"
                                            data-prereq-id="{{ prereq_skill.id }}">
                                            <i class="fas fa-times"></i> Удалить
                                        </button>
                                    </li>
                                    {% empty %}
                                    <li class="text-gray-400 italic">Нет предпосылок</li>
                                    {% endfor %}
                                </ul>
                            </div>
                            <div class="px-4 py-3 bg-blue-50 border-t border-blue-200 text-right">
                                <button type="button" id="add-prerequisite-btn" class="flex items-center gap-1 px-3 py-1 rounded-md font-medium transition-colors duration-200 border border-blue-600 text-blue-600 hover:bg-blue-600 hover:text-white text-sm">
                                    <i class="fas fa-plus"></i> Добавить предпосылку
                                </button>
                            </div>
                        </div>
                        <div class="bg-white rounded-lg shadow-md overflow-hidden border border-gray-200">
                            <div class="px-4 py-3 bg-green-50 border-b border-green-200 font-semibold">
                                <h6 class="text-md font-semibold text-green-700">
                                    От {% if selected_skill %}{{ selected_skill.name }}{% else %}навыка{% endif %} зависят
                                </h6>
                            </div>                            <div class="p-4">
                                <ul class="space-y-2">
                                    {% for dep_skill in dependent_skills %}
                                    <li class="flex items-center justify-between bg-green-100 rounded px-3 py-2">
                                        <div class="flex items-center">
                                            <span class="font-medium text-green-900">{{ dep_skill.name }}</span>
                                            <span class="text-xs text-green-500 ml-2">ID: {{ dep_skill.id }}</span>
                                        </div>
                                        <button type="button" class="remove-dependent-btn text-red-500 hover:text-red-700 ml-2" 
                                                data-skill-id="{{ selected_skill.id }}" data-dependent-id="{{ dep_skill.id }}"
                                                title="Убрать зависимость">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </li>
                                    {% empty %}
                                    <li class="text-gray-400 italic">Нет зависимых навыков</li>
                                    {% endfor %}
                                </ul>
                            </div>
                            <div class="px-4 py-3 bg-green-50 border-t border-green-200 text-right">
                                <button type="button" id="add-dependent-btn" class="flex items-center gap-1 px-3 py-1 rounded-md font-medium transition-colors duration-200 border border-green-600 text-green-600 hover:bg-green-600 hover:text-white text-sm">
                                    <i class="fas fa-plus"></i> Добавить зависимый навык
                                </button>
                            </div>
                        </div>
                    </div>

                    {% else %}
                    <div class="card">
                        <div class="card-body text-center py-12">
                            <i class="fas fa-info-circle text-blue-600 text-4xl mb-3"></i>
                            <h5 class="text-xl font-semibold mb-2">Выберите навык для редактирования</h5>
                            <p class="text-gray-600">Выберите навык из списка слева или создайте новый</p>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </main>

        <footer class="mt-12 text-center text-gray-500">
            <p>© 2023 Система адаптивного обучения</p>
        </footer>
    </div>
    
    <!-- Передача данных в JavaScript -->
    <script type="application/json" id="graph-data">{{ cytoscape_data|safe }}</script>
    <script type="text/plain" id="selected-skill-id">{{ selected_skill.id|default:'' }}</script>    <!-- Глобальные переменные для add-prerequisite.js -->
    <script id="courses-data" type="application/json">{{ courses_json|safe }}</script>
    <script id="skills-data" type="application/json">{{ skills_json|safe }}</script>
    <script>
    window.selectedSkillId = "{{ selected_skill.id|default:'' }}";
    window.courses = JSON.parse(document.getElementById('courses-data').textContent);
    window.allSkills = JSON.parse(document.getElementById('skills-data').textContent);
</script>

    <!-- Модальное окно для создания/редактирования навыка -->
    <div id="skill-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl max-w-md w-full">
            <div class="flex justify-between items-center border-b border-gray-200 p-4">
                <h4 id="modal-title" class="text-lg font-semibold">Создание нового навыка</h4>
                <button id="modal-close" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="p-4">
                <form id="skill-form" method="post" action="{% url 'edit_skill' %}">
                    {% csrf_token %}
                    <input type="hidden" id="edit-mode" name="edit_mode" value="create">
                    <input type="hidden" id="form-skill-id" name="skill_id" value="">
                    <input type="hidden" id="update-courses" name="update_courses" value="">
                    <div class="mb-4">
                        <label for="form-name" class="block font-medium text-gray-700 mb-1">Название навыка</label>
                        <input type="text" id="form-name" name="name" class="border border-gray-300 rounded px-3 py-2 w-full focus:outline-none focus:ring-2 focus:ring-blue-600 focus:border-transparent" required>
                    </div>
                    <div class="mb-4">
                        <label for="form-is-base" class="block font-medium text-gray-700 mb-1">Тип навыка</label>
                        <select id="form-is-base" name="is_base" class="border border-gray-300 rounded px-3 py-2 w-full focus:outline-none focus:ring-2 focus:ring-blue-600 focus:border-transparent">
                            <option value="false">Прикладной</option>
                            <option value="true">Базовый</option>
                        </select>
                    </div>
                    <div class="mb-4">
                        <label class="block font-medium text-gray-700 mb-1">Курсы</label>
                        <div class="bg-gray-50 p-3 rounded-md max-h-48 overflow-y-auto">
                            {% for course in courses %}
                            <div class="flex items-center mb-2">
                                <input type="checkbox" id="course-{{ course.id }}" name="courses" value="{{ course.id }}" class="form-checkbox">
                                <label for="course-{{ course.id }}" class="ml-2">{{ course.name }}</label>
                            </div>
                            {% empty %}
                            <p class="text-gray-500 italic">Курсы не найдены</p>
                            {% endfor %}
                        </div>
                    </div>
                    <div class="flex justify-end gap-2 mt-4">
                        <button type="button" id="modal-cancel" class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50">
                            Отмена
                        </button>
                        <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                            Сохранить
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Модальное окно для подтверждения удаления -->
    <div id="confirm-delete-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl max-w-md w-full p-6">
            <div class="flex justify-between items-center mb-3">
                <h4 class="text-lg font-semibold">Подтверждение удаления</h4>
                <button class="text-gray-400 hover:text-gray-600 close-btn">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <p>Вы действительно хотите удалить навык "<span id="delete-skill-name" class="font-semibold"></span>"?</p>
            <p class="text-red-600 text-sm mt-2">Внимание: Все связи этого навыка также будут удалены.</p>
            <div class="flex justify-end gap-2 mt-4">
                <button id="cancel-delete" class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50">
                    Отмена
                </button>
                <form method="post" action="{% url 'delete_skill' %}">
                    {% csrf_token %}
                    <input type="hidden" id="delete-skill-id" name="skill_id" value="">
                    <button type="submit" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700">
                        Удалить
                    </button>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Модальное окно для добавления предпосылки -->
    <div id="add-prerequisite-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl max-w-lg w-full">
            <div class="flex justify-between items-center border-b border-gray-200 p-4">
                <h4 class="text-lg font-semibold">Добавить предпосылку для <span class="selected-skill-name"></span></h4>
                <button class="text-gray-400 hover:text-gray-600 close-btn">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="p-4">
                <div class="flex gap-2 mb-3">
                    <select class="course-filter border border-gray-300 rounded px-3 py-2 w-1/2 focus:outline-none focus:ring-2 focus:ring-blue-600 focus:border-transparent">
                        <option value="">Все курсы</option>
                    </select>
                    <input type="text" class="name-filter border border-gray-300 rounded px-3 py-2 w-1/2 focus:outline-none focus:ring-2 focus:ring-blue-600 focus:border-transparent" placeholder="Поиск по названию">
                </div>
                <div class="skills-list max-h-60 overflow-y-auto border rounded p-2 bg-gray-50"></div>
                <div class="flex justify-end gap-2 mt-4">
                    <button type="button" class="cancel-btn px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50">
                        Отмена
                    </button>
                    <button type="button" class="save-btn px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                        Добавить
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Модальное окно для подтверждения удаления связи "зависит от" -->
    <div id="confirm-remove-prereq-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl max-w-md w-full p-6">
            <div class="flex justify-between items-center mb-3">
                <h4 class="text-lg font-semibold">Подтверждение удаления связи</h4>
                <button class="text-gray-400 hover:text-gray-600 close-btn" id="close-remove-prereq-modal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <p>Вы действительно хотите удалить связь "зависит от" с навыком <span id="remove-prereq-skill-name" class="font-semibold"></span>?</p>
            <div class="flex justify-end gap-2 mt-4">
                <button id="cancel-remove-prereq" class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50">
                    Отмена
                </button>
                <button id="confirm-remove-prereq" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700">
                    Удалить
                </button>
            </div>
        </div>
    </div>
    
    <!-- Модальное окно для добавления зависимого навыка -->
    <div id="add-dependent-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl max-w-lg w-full">
            <div class="flex justify-between items-center border-b border-gray-200 p-4">
                <h4 class="text-lg font-semibold">Добавить зависимый навык для <span class="selected-skill-name"></span></h4>
                <button class="text-gray-400 hover:text-gray-600 close-btn">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="p-4">
                <div class="flex gap-2 mb-3">
                    <select class="course-filter border border-gray-300 rounded px-3 py-2 w-1/2 focus:outline-none focus:ring-2 focus:ring-blue-600 focus:border-transparent">
                        <option value="">Все курсы</option>
                    </select>
                    <input type="text" class="name-filter border border-gray-300 rounded px-3 py-2 w-1/2 focus:outline-none focus:ring-2 focus:ring-blue-600 focus:border-transparent" placeholder="Поиск по названию">
                </div>
                <div class="skills-list max-h-60 overflow-y-auto border rounded p-2 bg-gray-50"></div>
                <div class="flex justify-end gap-2 mt-4">
                    <button type="button" class="cancel-btn px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50">
                        Отмена
                    </button>
                    <button type="button" class="save-btn px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700">
                        Добавить
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Подключение JavaScript -->
    <script src="{% static 'skills/js/network.js' %}"></script>
    <script src="{% static 'skills/js/delete-modal.js' %}"></script>
    <script src="{% static 'skills/js/skill-modal.js' %}"></script>
    <script src="{% static 'skills/skills_edit.js' %}"></script>    <script src="{% static 'skills/js/add-prerequisite.js' %}"></script>
    <script src="{% static 'skills/js/remove-prerequisite.js' %}"></script>
    <script src="{% static 'skills/js/add-dependent.js' %}"></script>
    <script src="{% static 'skills/js/remove-dependent.js' %}"></script>
</body>
</html>
