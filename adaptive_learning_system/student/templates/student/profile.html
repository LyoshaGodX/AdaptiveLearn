{% extends 'student/base.html' %}
{% load student_filters %}
{% load static %}

{% block title %}–ü—Ä–æ—Ñ–∏–ª—å —Å—Ç—É–¥–µ–Ω—Ç–∞ - {{ profile.full_name }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'student/css/profile.css' %}">
<link rel="stylesheet" href="{% static 'student/css/courses.css' %}">
<link rel="stylesheet" href="{% static 'student/css/skills.css' %}">
<link rel="stylesheet" href="{% static 'student/css/recommendations.css' %}">
<link rel="stylesheet" href="{% static 'student/css/progress_bars.css' %}">
<style>
.progress-bar-new { width: 100%; height: 8px; background-color: #e9ecef !important; border-radius: 4px; overflow: hidden; position: relative; margin: 0.5rem 0; box-shadow: inset 0 1px 2px rgba(0,0,0,0.1); }
.progress-bar-new.thick { height: 12px !important; border-radius: 6px; }
.progress-fill-new { height: 100%; width: 0%; background: #007bff !important; border-radius: inherit; transition: width 0.6s ease; position: relative; }
.progress-fill-new.primary { background: linear-gradient(90deg, #007bff 0%, #0056b3 100%) !important; }
.progress-fill-new.success { background: linear-gradient(90deg, #28a745 0%, #1e7e34 100%) !important; }
.skill-progress-container .progress-bar-new { height: 10px !important; background-color: #f8f9fa !important; }
.course-progress-container .progress-bar-new { height: 8px !important; background-color: #f5f5f5 !important; }
.recommendation-progress-container .progress-bar-new { height: 12px !important; background-color: #f8f9fa !important; border: 1px solid #dee2e6; }
</style>
{% endblock %}

{% block content %}
<div class="profile-container">
    <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ –ø—Ä–æ—Ñ–∏–ª—è -->
    <div class="profile-header">
        <div class="profile-info">
            {% if profile.profile_photo %}
                <img src="{{ profile.profile_photo.url }}" alt="–ê–≤–∞—Ç–∞—Ä" class="profile-avatar">
            {% else %}
                <div class="profile-avatar-placeholder">
                    {{ profile.full_name|first|upper }}
                </div>
            {% endif %}
            <div class="profile-details">
                <h1 class="profile-name">{{ profile.full_name }}</h1>
                <p class="profile-email">{{ profile.email }}</p>
                <p class="profile-join-date">–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª—Å—è: {{ profile.created_at|date:"d.m.Y" }}</p>
            </div>
        </div>
    </div>

    <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-icon">üìö</div>
            <div class="stat-content">
                <h3>{{ total_attempts }}</h3>
                <p>–í—ã–ø–æ–ª–Ω–µ–Ω–æ –∑–∞–¥–∞–Ω–∏–π</p>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">‚≠ê</div>
            <div class="stat-content">
                <h3>{{ accuracy }}%</h3>
                <p>–¢–æ—á–Ω–æ—Å—Ç—å —Ä–µ—à–µ–Ω–∏—è</p>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">üéØ</div>
            <div class="stat-content">
                <h3>{{ learning_streak }}</h3>
                <p>–î–Ω–µ–π –ø–æ–¥—Ä—è–¥</p>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">üèÜ</div>
            <div class="stat-content">
                <h3>{{ level }}</h3>
                <p>–£—Ä–æ–≤–µ–Ω—å</p>
            </div>
        </div>
    </div>    <!-- –¢–µ–∫—É—â–∞—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è -->
    {% if current_recommendation %}
    <div class="section-card">
        <div class="section-header">
            <h2>üéØ –†–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–Ω–æ–µ –∑–∞–¥–∞–Ω–∏–µ</h2>
        </div>
        <div class="recommendation-content">
            <!-- –ö–∞—Ä—Ç–æ—á–∫–∞ —Ä–∞–∑–≤–∏–≤–∞–µ–º–æ–≥–æ –Ω–∞–≤—ã–∫–∞ - –ø–µ—Ä–µ–º–µ—Å—Ç–∏–ª–∏ –Ω–∞–≤–µ—Ä—Ö -->
            {% if target_skill_info %}
            <div class="target-skill-card">
                <div class="skill-header">
                    <h4>üéØ –†–∞–∑–≤–∏–≤–∞–µ–º—ã–π –Ω–∞–≤—ã–∫</h4>
                    <span class="skill-level">{{ target_skill_info.mastery_percentage }}%</span>
                </div>                <div class="skill-info">
                    <h5>{{ target_skill_info.skill.name }}</h5>
                    <div class="progress-stats">
                        <span>{{ target_skill_info.correct_attempts }}/{{ target_skill_info.attempts_count }} –ø–æ–ø—ã—Ç–æ–∫</span>
                    </div>
                    {% if target_skill_info.skill.description %}
                    <p class="skill-description">{{ target_skill_info.skill.description }}</p>
                    {% endif %}
                </div>
            </div>
            {% endif %}

            <div class="recommendation-main">
                <div class="recommendation-task">
                    <h3>{{ current_recommendation.task.title }}</h3>
                    <div class="task-badges">
                        <span class="task-difficulty">{{ current_recommendation.task.get_difficulty_display }}</span>
                        <span class="task-type">{{ current_recommendation.task.get_task_type_display }}</span>
                    </div>
                </div>

                <div class="recommendation-metrics">
                    <div class="metric-card">
                        <div class="metric-icon">üìä</div>
                        <div class="metric-content">
                            <span class="metric-label">–£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å</span>
                            <span class="metric-value">{{ current_recommendation.confidence_percentage }}%</span>
                        </div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-icon">üéØ</div>
                        <div class="metric-content">
                            <span class="metric-label">Q-value</span>
                            <span class="metric-value">{{ current_recommendation.q_value|floatformat:3 }}</span>
                        </div>
                    </div>
                </div>

                {% if current_recommendation.llm_explanation %}
                <div class="recommendation-explanation">
                    <h4>üí° –û–±—ä—è—Å–Ω–µ–Ω–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏</h4>
                    <p>{{ current_recommendation.llm_explanation }}</p>
                </div>
                {% endif %}

                <div class="recommendation-actions">
                    <a href="#" class="btn btn-primary btn-large">üöÄ –†–µ—à–∏—Ç—å –∑–∞–¥–∞–Ω–∏–µ</a>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- –ö—É—Ä—Å—ã –∏ –∏—Ö –ø—Ä–æ–≥—Ä–µ—Å—Å -->
    <div class="section-card">
        <div class="section-header">
            <h2>üìñ –ú–æ–∏ –∫—É—Ä—Å—ã ({{ total_courses }})</h2>
        </div>
        <div class="courses-grid">
            {% for course_data in course_progress_data %}
            <div class="course-card">
                <div class="course-header">
                    <h3>{{ course_data.enrollment.course.name }}</h3>
                    <span class="course-status status-{{ course_data.enrollment.status }}">
                        {{ course_data.enrollment.get_status_display }}
                    </span>
                </div>                <div class="course-progress">
                    <div class="progress-info">
                        <span>–ü—Ä–æ–≥—Ä–µ—Å—Å: <span class="skill-percentage {{ course_data.avg_mastery_css_class }}">{{ course_data.avg_mastery_percentage }}%</span></span>
                        <span>{{ course_data.mastered_skills }}/{{ course_data.total_skills }} –Ω–∞–≤—ã–∫–æ–≤</span>
                    </div>
                </div><div class="course-skills">
                    <h4>–ù–∞–≤—ã–∫–∏ –∫—É—Ä—Å–∞:</h4>
                    <div class="skills-list">                        {% for skill_info in course_data.skills_with_mastery %}
                        <div class="skill-tag">
                            {{ skill_info.skill.name }}
                            <span class="skill-mastery {{ skill_info.mastery_css_class }}">{{ skill_info.mastery_percentage }}%</span>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% empty %}
            <div class="empty-state">
                <p>–í—ã –ø–æ–∫–∞ –Ω–µ –∑–∞–ø–∏—Å–∞–Ω—ã –Ω–∏ –Ω–∞ –æ–¥–∏–Ω –∫—É—Ä—Å</p>
                <a href="#" class="btn btn-primary">–ù–∞–π—Ç–∏ –∫—É—Ä—Å—ã</a>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- –ù–∞–≤—ã–∫–∏ –∏ –∏—Ö –æ—Å–≤–æ–µ–Ω–∏–µ -->
    <div class="section-card">
        <div class="section-header">
            <h2>üß† –ú–æ–∏ –Ω–∞–≤—ã–∫–∏ ({{ total_skills }})</h2>
            <div class="skills-summary">
                <span class="mastered">–û—Å–≤–æ–µ–Ω–æ: {{ mastered_skills_count }}</span>
                <span class="in-progress">–í –∏–∑—É—á–µ–Ω–∏–∏: {{ in_progress_skills_count }}</span>
                <span class="weak">–¢—Ä–µ–±—É–µ—Ç –≤–Ω–∏–º–∞–Ω–∏—è: {{ weak_skills_count }}</span>
            </div>
        </div>
        <div class="skills-grid">
            {% for skill_mastery in skill_masteries %}            <div class="skill-card {% if skill_mastery.current_mastery_prob >= 0.8 %}mastered{% elif skill_mastery.current_mastery_prob >= 0.3 %}in-progress{% else %}weak{% endif %}">                <div class="skill-header">
                    <h3>{{ skill_mastery.skill.name }}</h3>
                    <span class="skill-percentage {{ skill_mastery.mastery_css_class }}">{{ skill_mastery.mastery_percentage }}%</span>
                </div>
                <div class="skill-details">
                    <div class="skill-stats">
                        <span>–ü–æ–ø—ã—Ç–æ–∫: {{ skill_mastery.attempts_count }}</span>
                        <span>–ü—Ä–∞–≤–∏–ª—å–Ω—ã—Ö: {{ skill_mastery.correct_attempts }}</span>
                    </div>                    
                </div>
            </div>
            {% empty %}
            <div class="empty-state">
                <p>–ù–∞–≤—ã–∫–∏ –ø–æ–∫–∞ –Ω–µ –æ—Ç—Å–ª–µ–∂–∏–≤–∞—é—Ç—Å—è</p>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- –ü–æ—Å–ª–µ–¥–Ω–∏–µ –ø–æ–ø—ã—Ç–∫–∏ —Ä–µ—à–µ–Ω–∏—è –∑–∞–¥–∞–Ω–∏–π -->
    <div class="section-card">
        <div class="section-header">
            <h2>üìù –ü–æ—Å–ª–µ–¥–Ω–∏–µ 20 —Ä–µ—à–µ–Ω–∏–π</h2>
        </div>
        <div class="attempts-list">
            {% for attempt in recent_attempts %}
            <div class="attempt-item {% if attempt.is_correct %}correct{% else %}incorrect{% endif %}">
                <div class="attempt-task">
                    <h4>{{ attempt.task.title }}</h4>
                    <div class="task-skills">
                        {% for skill in attempt.task.skills.all %}
                            <span class="task-skill">{{ skill.name }}</span>
                        {% endfor %}
                    </div>
                </div>
                <div class="attempt-result">
                    <span class="result-icon">{% if attempt.is_correct %}‚úÖ{% else %}‚ùå{% endif %}</span>
                    <div class="attempt-details">
                        <span class="attempt-time">{{ attempt.completed_at|date:"d.m H:i" }}</span>
                        <span class="time-spent">{{ attempt.time_spent }}—Å</span>
                    </div>
                </div>
            </div>
            {% empty %}
            <div class="empty-state">
                <p>–†–µ—à–µ–Ω–∏–π –ø–æ–∫–∞ –Ω–µ—Ç</p>
            </div>
            {% endfor %}
        </div>
    </div>    <!-- –ü—Ä–æ—Ñ–∏–ª—å –æ–±—É—á–µ–Ω–∏—è -->
    {% if learning_profile %}
    <div class="section-card">
        <div class="section-header">
            <h2>‚öôÔ∏è –ü—Ä–æ—Ñ–∏–ª—å –æ–±—É—á–µ–Ω–∏—è</h2>
        </div>
        <div class="learning-profile-grid">
            <div class="profile-metric">
                <h4>–°–∫–æ—Ä–æ—Å—Ç—å –æ–±—É—á–µ–Ω–∏—è</h4>
                <div class="metric-bar">
                    <div class="metric-fill" style="width: {{ learning_profile.learning_speed|floatformat:0 }}%"></div>
                </div>
                <span>{{ learning_profile.learning_speed|floatformat:2 }}</span>
            </div>
            <div class="profile-metric">
                <h4>–ù–∞—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å</h4>
                <div class="metric-bar">
                    <div class="metric-fill" style="width: {{ learning_profile.persistence_level|floatformat:0 }}%"></div>
                </div>
                <span>{{ learning_profile.persistence_level|floatformat:2 }}</span>
            </div>
            <div class="profile-metric">
                <h4>–ü—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è —Å–ª–æ–∂–Ω–æ—Å—Ç–∏</h4>
                <span class="difficulty-preference">{{ learning_profile.get_difficulty_preference_display }}</span>
            </div>
            <div class="profile-metric">
                <h4>–°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –Ω–∞ –∑–∞–¥–∞–Ω–∏–µ</h4>
                <span>{{ learning_profile.average_time_per_task|floatformat:1 }} –º–∏–Ω</span>
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'student/js/profile.js' %}"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const progressFills = document.querySelectorAll('.progress-fill-new');
    progressFills.forEach(function(fill) {
        const widthStyle = fill.style.width;
        if (widthStyle) {
            fill.style.width = '0%';
            setTimeout(function() {
                fill.style.width = widthStyle;
            }, 100);
        }
    });
});
</script>
{% endblock %}
